name: Build & Deploy Backend

on:
  push:
    branches: [ "master" ]
    paths:
      - "backend/**"
      - "docker-compose.prod.yml"
      - ".github/workflows/**"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build backend jar
        working-directory: backend
        run: |
          chmod +x gradlew
          ./gradlew bootJar -x test --no-daemon

      # 여기서 GitHub 러너 → 오라클 VM 으로 jar 전송
      - name: Copy jar to Oracle VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}      
          username: ${{ secrets.SSH_USER }}  
          key: ${{ secrets.SSH_KEY }}        # 개인키
          port: 22
          # 빌드된 jar 는 레포 루트 기준으로 backend/build/libs에 있음
          source: "backend/build/libs/*.jar,docker-compose.prod.yml"
          target: "/home/ubuntu/lostark/"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 20m
          script: |
            set -e
            cd ~/lostark

            echo ">>> backend/build/libs 내용 확인"
            ls -R backend/build || echo "build dir not present"

            echo ">>> 최신 jar를 app.jar로 고정"
            jar_path="$(ls -t backend/build/libs/*.jar 2>/dev/null | grep -v '/app\\.jar$' | head -n 1 || true)"
            if [ -z "$jar_path" ]; then
              echo "ERROR: backend/build/libs 에 jar 파일이 없습니다."
              exit 1
            fi
            cp -f "$jar_path" backend/build/libs/app.jar
            ls -l backend/build/libs/app.jar

            echo ">>> restart backend"
            docker compose -f docker-compose.prod.yml up -d --no-build --force-recreate backend
